version: "3.0"

rules:

- rule: Activate Validate User and Send Transfer form
  condition:
  - slot_was_set:
    - user_verified: None
  steps:
  - intent: send_transfer
  - action: utter_request_authentication
  - action: user_authentication_form
  - active_loop: user_authentication_form
  - slot_was_set:
    - requested_slot: null
  - active_loop: null
  - action: send_transfer_form
  - active_loop: send_transfer_form

- rule: User already validated, activate Send Transfer form
  condition:
  - slot_was_set:
    - user_verified: true
  steps:
  - intent: send_transfer
  - action: send_transfer_form
  - active_loop: send_transfer_form

- rule: Submit Transfer form
  condition:
  - slot_was_set:
    - user_verified: true
  - active_loop: send_transfer_form
  steps:
  - action: send_transfer_form
  - active_loop: null
  - slot_was_set:
    - requested_slot: null
  - action: utter_send_transfer_slots
  - intent: affirm
  - action: utter_submit
  - action: action_send_transfer
  - action: action_send_receipt

- rule: final submission
  condition:
  - slot_was_set:
    - user_verified: true
  steps:
  - action: utter_send_transfer_slots
  - intent: affirm
  - action: utter_submit
  - action: action_send_transfer
  - action: action_send_receipt

- rule: scenario 1, user not validated
  condition:
  - slot_was_set:
    - user_verified: None
  steps:
  - intent: inform
    entities:
    - number: '100'
    - number: '3'
  - slot_was_set:
    - transfer_recipient: '3'
  - slot_was_set:
    - transfer_amount: '100'
  - action: utter_request_authentication
  - action: user_authentication_form
  - active_loop: user_authentication_form
  - active_loop: null
  - slot_was_set:
    - requested_slot: null
  - action: send_transfer_form
  - active_loop: send_transfer_form
  - active_loop: null
  - slot_was_set:
    - requested_slot: null
  - action: utter_send_transfer_slots
  # - action: validate_send_transfer_form
  # - action: utter_send_transfer_slots

- rule: scenario 1, user already validated
  condition:
  - slot_was_set:
    - user_verified: true
  steps:
  - intent: inform
    entities:
    - number: '100'
    - number: '3'
  - slot_was_set:
    - transfer_recipient: '3'
  - slot_was_set:
    - transfer_amount: '100'
  - action: send_transfer_form
  - active_loop: send_transfer_form
  - active_loop: null
  - slot_was_set:
    - requested_slot: null
  - action: utter_send_transfer_slots
  # - action: validate_send_transfer_form
  # - action: utter_send_transfer_slots

- rule: scenario 2, user not validated
  condition:
  - slot_was_set:
    - user_verified: None
  steps:
  - intent: inform
    entities:
    - number: '3'
  - slot_was_set:
    - transfer_recipient: '3'
  - action: utter_request_authentication
  - action: user_authentication_form
  - active_loop: user_authentication_form
  - active_loop: null
  - slot_was_set:
    - requested_slot: null
  # - action: validate_send_transfer_form
  - action: send_transfer_form
  - active_loop: send_transfer_form
  - slot_was_set:
    - requested_slot: null
  - active_loop: null
  - action: utter_send_transfer_slots

- rule: scenario 2, user validated
  condition:
  - slot_was_set:
    - user_verified: true
  steps:
  - intent: inform
    entities:
    - number: '3'
  - slot_was_set:
    - transfer_recipient: '3'
  - action: send_transfer_form
  - active_loop: send_transfer_form
  - slot_was_set:
    - requested_slot: null
  - active_loop: null
  - action: utter_send_transfer_slots

- rule: scenario 3, user not validated
  condition:
  - slot_was_set:
    - user_verified: None
  steps:
  - intent: inform
    entities:
    - number: '100'
  - slot_was_set:
    - transfer_amount: '100'
  - action: utter_request_authentication
  - action: user_authentication_form
  - active_loop: user_authentication_form
  - active_loop: null
  - slot_was_set:
    - requested_slot: null
  # - action: validate_send_transfer_form
  - action: send_transfer_form
  - active_loop: send_transfer_form
  - slot_was_set:
    - requested_slot: null
  - active_loop: null
  - action: utter_send_transfer_slots

- rule: scenario 3, user validated
  condition:
  - slot_was_set:
    - user_verified: true
  steps:
  - intent: inform
    entities:
    - number: '100'
  - slot_was_set:
    - transfer_amount: '100'
  - action: send_transfer_form
  - active_loop: send_transfer_form
  - slot_was_set:
    - requested_slot: null
  - active_loop: null
  - action: utter_send_transfer_slots

# Follow this pattern as chitchat is built out:
# - rule: Unhappy path, chitchat within form
#   condition:
#   - active_loop: send_transfer_form
#   steps:
#   - intent: chitchat
#   - action: utter_chitchat
#   - action: send_transfer_form
#   - active_loop: send_transfer_form

# User cancels non-existent transaction NEED TO UPDATE THIS
# - rule: User cancels non-existent transaction
#   steps:
#   - intent: modify_transfer
#   - action: utter_confirm_modify_transfer
#   - action: action_extract_slots
#   - action: send_transfer_form
#   - active_loop: send_transfer_form

# User modifies transfer within loop
- rule: User modifies transfer within loop
  condition:
  - slot_was_set:
    - user_verified: true
  - active_loop: send_transfer_form
  steps:
  - intent: modify_transfer
  - action: utter_confirm_modify_transfer
  - action: action_extract_slots
  - action: send_transfer_form
  - active_loop: send_transfer_form

# User modifies transfer outside loop
- rule: User modifies transfer outside loop
  condition:
  - slot_was_set:
    - user_verified: true 
  - active_loop: null
  steps:
  - intent: modify_transfer
  - action: utter_confirm_modify_transfer
  - action: action_extract_slots
  - action: send_transfer_form
  - active_loop: send_transfer_form
  # - action: validate_send_transfer_form
  # - action: utter_send_transfer_slots

- rule: User resets transfer
  condition:
  - slot_was_set:
    - user_verified: true 
  steps:
  - intent: reset_transfer
  - action: utter_confirm_reset_transfer
  - action: action_slot_reset
  - action: send_transfer_form
  - active_loop: send_transfer_form

# User changes their mind about cancelling within loop

# User changes their mind about cancelling outside loop

- rule: Cancellation followup within form
  condition:
  - slot_was_set:
    - user_verified: true 
  - active_loop: send_transfer_form
  steps:
  - action: utter_ask_continue
  - action: action_listen
  - or:
    - intent: affirm
    - intent: cancel_transfer
  - action: action_deactivate_loop
  - active_loop: null
  - action: action_slot_reset
  - action: utter_confirm_cancellation
  - action: action_listen

- rule: Cancellation followup outside form
  condition:
  - slot_was_set:
    - user_verified: true
  - active_loop: null
  steps:
  - action: utter_ask_continue
  - action: action_listen
  - or:
    - intent: affirm
    - intent: cancel_transfer
  - action: action_slot_reset
  - action: utter_confirm_cancellation
  - action: action_listen

- rule: Cancellation triggered within form
  condition:
  - slot_was_set:
    - user_verified: true
  - active_loop: send_transfer_form
  steps:
  - intent: cancel_transfer
  - action: utter_ask_continue
  - action: action_listen

- rule: Cancellation triggered after both slots filled
  condition:
  - slot_was_set:
    - user_verified: true
  steps:
  - action: utter_send_transfer_slots
  - or:
    - intent: deny
    - intent: cancel_transfer
  - action: utter_ask_continue
  - action: action_listen

- rule: Say goodbye anytime the user says goodbye
  steps:
  - intent: goodbye
  - action: utter_goodbye
